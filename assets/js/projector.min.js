THREE.RenderableObject=function(){this.id=0,this.object=null,this.z=0},THREE.RenderableFace=function(){this.id=0,this.v1=new THREE.RenderableVertex,this.v2=new THREE.RenderableVertex,this.v3=new THREE.RenderableVertex,this.normalModel=new THREE.Vector3,this.vertexNormalsModel=[new THREE.Vector3,new THREE.Vector3,new THREE.Vector3],this.vertexNormalsLength=0,this.color=new THREE.Color,this.material=null,this.uvs=[new THREE.Vector2,new THREE.Vector2,new THREE.Vector2],this.z=0},THREE.RenderableVertex=function(){this.position=new THREE.Vector3,this.positionWorld=new THREE.Vector3,this.positionScreen=new THREE.Vector4,this.visible=!0},THREE.RenderableVertex.prototype.copy=function(e){this.positionWorld.copy(e.positionWorld),this.positionScreen.copy(e.positionScreen)},THREE.RenderableLine=function(){this.id=0,this.v1=new THREE.RenderableVertex,this.v2=new THREE.RenderableVertex,this.vertexColors=[new THREE.Color,new THREE.Color],this.material=null,this.z=0},THREE.RenderableSprite=function(){this.id=0,this.object=null,this.x=0,this.y=0,this.z=0,this.rotation=0,this.scale=new THREE.Vector2,this.material=null},THREE.Projector=function(){var e,t,r,i,o,n,a,s,c,l,p,E=[],u=0,h=[],f=0,v=[],m=0,R=[],d=0,x=[],T=0,y={objects:[],lights:[],elements:[]},H=new THREE.Vector3,w=new THREE.Vector4,g=new THREE.Box3(new THREE.Vector3(-1,-1,-1),new THREE.Vector3(1,1,1)),b=new THREE.Box3,M=new Array(3),S=(new Array(4),new THREE.Matrix4),z=new THREE.Matrix4,V=new THREE.Matrix4,j=new THREE.Matrix3,L=new THREE.Frustum,C=new THREE.Vector4,k=new THREE.Vector4;this.projectVector=function(e,t){console.warn("THREE.Projector: .projectVector() is now vector.project()."),e.project(t)},this.unprojectVector=function(e,t){console.warn("THREE.Projector: .unprojectVector() is now vector.unproject()."),e.unproject(t)},this.pickingRay=function(e,t){console.error("THREE.Projector: .pickingRay() is now raycaster.setFromCamera().")};var N=new function(){var e=[],t=[],i=null,n=null,s=new THREE.Matrix3,c=function(e){var t=e.position,r=e.positionWorld,i=e.positionScreen;r.copy(t).applyMatrix4(p),i.copy(r).applyMatrix4(z);var o=1/i.w;i.x*=o,i.y*=o,i.z*=o,e.visible=i.x>=-1&&i.x<=1&&i.y>=-1&&i.y<=1&&i.z>=-1&&i.z<=1},l=function(e,t,r){return!0===e.visible||!0===t.visible||!0===r.visible||(M[0]=e.positionScreen,M[1]=t.positionScreen,M[2]=r.positionScreen,g.isIntersectionBox(b.setFromPoints(M)))},E=function(e,t,r){return(r.positionScreen.x-e.positionScreen.x)*(t.positionScreen.y-e.positionScreen.y)-(r.positionScreen.y-e.positionScreen.y)*(t.positionScreen.x-e.positionScreen.x)<0};return{setObject:function(r){n=(i=r).material,s.getNormalMatrix(i.matrixWorld),e.length=0,t.length=0},projectVertex:c,checkTriangleVisibility:l,checkBackfaceCulling:E,pushVertex:function(e,t,i){(r=W()).position.set(e,t,i),c(r)},pushNormal:function(t,r,i){e.push(t,r,i)},pushUv:function(e,r){t.push(e,r)},pushLine:function(e,t){var r=h[e],o=h[t];(a=F()).id=i.id,a.v1.copy(r),a.v2.copy(o),a.z=(r.positionScreen.z+o.positionScreen.z)/2,a.material=i.material,y.elements.push(a)},pushTriangle:function(r,a,c){var p=h[r],u=h[a],f=h[c];if(!1!==l(p,u,f)&&(n.side===THREE.DoubleSide||!0===E(p,u,f))){(o=B()).id=i.id,o.v1.copy(p),o.v2.copy(u),o.v3.copy(f),o.z=(p.positionScreen.z+u.positionScreen.z+f.positionScreen.z)/3;for(var v=0;v<3;v++){var m=3*arguments[v],R=o.vertexNormalsModel[v];R.set(e[m],e[m+1],e[m+2]),R.applyMatrix3(s).normalize();var d=2*arguments[v];o.uvs[v].set(t[d],t[d+1])}o.vertexNormalsLength=3,o.material=i.material,y.elements.push(o)}}}};function W(){if(i===f){var e=new THREE.RenderableVertex;return h.push(e),f++,i++,e}return h[i++]}function B(){if(n===m){var e=new THREE.RenderableFace;return v.push(e),m++,n++,e}return v[n++]}function F(){if(s===d){var e=new THREE.RenderableLine;return R.push(e),d++,s++,e}return R[s++]}function P(){if(l===T){var e=new THREE.RenderableSprite;return x.push(e),T++,l++,e}return x[l++]}function I(e,t){return e.z!==t.z?t.z-e.z:e.id!==t.id?e.id-t.id:0}function O(e,t){var r=0,i=1,o=e.z+e.w,n=t.z+t.w,a=-e.z+e.w,s=-t.z+t.w;return o>=0&&n>=0&&a>=0&&s>=0||!(o<0&&n<0||a<0&&s<0)&&(o<0?r=Math.max(r,o/(o-n)):n<0&&(i=Math.min(i,o/(o-n))),a<0?r=Math.max(r,a/(a-s)):s<0&&(i=Math.min(i,a/(a-s))),!(i<r)&&(e.lerp(t,r),t.lerp(e,1-i),!0))}this.projectScene=function(r,f,v,m){n=0,s=0,l=0,y.elements.length=0,!0===r.autoUpdate&&r.updateMatrixWorld(),void 0===f.parent&&f.updateMatrixWorld(),S.copy(f.matrixWorldInverse.getInverse(f.matrixWorld)),z.multiplyMatrices(f.projectionMatrix,S),L.setFromMatrix(z),t=0,y.objects.length=0,y.lights.length=0,r.traverseVisible(function(r){if(r instanceof THREE.Light)y.lights.push(r);else if(r instanceof THREE.Mesh||r instanceof THREE.Line||r instanceof THREE.Sprite){if(!1===r.material.visible)return;!1!==r.frustumCulled&&!0!==L.intersectsObject(r)||((e=function(){if(t===u){var e=new THREE.RenderableObject;return E.push(e),u++,t++,e}return E[t++]}()).id=r.id,e.object=r,H.setFromMatrixPosition(r.matrixWorld),H.applyProjection(z),e.z=H.z,y.objects.push(e))}}),!0===v&&y.objects.sort(I);for(var R=0,d=y.objects.length;R<d;R++){var x=y.objects[R].object,T=x.geometry;if(N.setObject(x),p=x.matrixWorld,i=0,x instanceof THREE.Mesh){if(T instanceof THREE.BufferGeometry){var g=T.attributes,b=T.offsets;if(void 0===g.position)continue;for(var M=0,D=(He=g.position.array).length;M<D;M+=3)N.pushVertex(He[M],He[M+1],He[M+2]);if(void 0!==g.normal){var G=g.normal.array;for(M=0,D=G.length;M<D;M+=3)N.pushNormal(G[M],G[M+1],G[M+2])}if(void 0!==g.uv){var U=g.uv.array;for(M=0,D=U.length;M<D;M+=2)N.pushUv(U[M],U[M+1])}if(void 0!==g.index){var A=g.index.array;if(b.length>0)for(R=0;R<b.length;R++){var q=b[R],J=q.index;for(M=q.start,D=q.start+q.count;M<D;M+=3)N.pushTriangle(A[M]+J,A[M+1]+J,A[M+2]+J)}else for(M=0,D=A.length;M<D;M+=3)N.pushTriangle(A[M],A[M+1],A[M+2])}else for(M=0,D=He.length/3;M<D;M+=3)N.pushTriangle(M,M+1,M+2)}else if(T instanceof THREE.Geometry){var K=T.vertices,Q=T.faces,X=T.faceVertexUvs[0];j.getNormalMatrix(p);for(var Y=(le=x.material)instanceof THREE.MeshFaceMaterial,Z=!0===Y?x.material:null,$=0,_=K.length;$<_;$++){var ee=K[$];if(H.copy(ee),!0===le.morphTargets)for(var te=T.morphTargets,re=x.morphTargetInfluences,ie=0,oe=te.length;ie<oe;ie++){var ne=re[ie];if(0!==ne){var ae=te[ie].vertices[$];H.x+=(ae.x-ee.x)*ne,H.y+=(ae.y-ee.y)*ne,H.z+=(ae.z-ee.z)*ne}}N.pushVertex(H.x,H.y,H.z)}for(var se=0,ce=Q.length;se<ce;se++){var le,pe=Q[se];if(void 0!==(le=!0===Y?Z.materials[pe.materialIndex]:x.material)){var Ee=le.side,ue=h[pe.a],he=h[pe.b],fe=h[pe.c];if(!1!==N.checkTriangleVisibility(ue,he,fe)){var ve=N.checkBackfaceCulling(ue,he,fe);if(Ee!==THREE.DoubleSide){if(Ee===THREE.FrontSide&&!1===ve)continue;if(Ee===THREE.BackSide&&!0===ve)continue}(o=B()).id=x.id,o.v1.copy(ue),o.v2.copy(he),o.v3.copy(fe),o.normalModel.copy(pe.normal),!1!==ve||Ee!==THREE.BackSide&&Ee!==THREE.DoubleSide||o.normalModel.negate(),o.normalModel.applyMatrix3(j).normalize();for(var me=pe.vertexNormals,Re=0,de=Math.min(me.length,3);Re<de;Re++){var xe=o.vertexNormalsModel[Re];xe.copy(me[Re]),!1!==ve||Ee!==THREE.BackSide&&Ee!==THREE.DoubleSide||xe.negate(),xe.applyMatrix3(j).normalize()}o.vertexNormalsLength=me.length;var Te=X[se];if(void 0!==Te)for(var ye=0;ye<3;ye++)o.uvs[ye].copy(Te[ye]);o.color=pe.color,o.material=le,o.z=(ue.positionScreen.z+he.positionScreen.z+fe.positionScreen.z)/3,y.elements.push(o)}}}}}else if(x instanceof THREE.Line){if(T instanceof THREE.BufferGeometry){if(void 0!==(g=T.attributes).position){var He;for(M=0,D=(He=g.position.array).length;M<D;M+=3)N.pushVertex(He[M],He[M+1],He[M+2]);if(void 0!==g.index)for(M=0,D=(A=g.index.array).length;M<D;M+=2)N.pushLine(A[M],A[M+1]);else{var we=x.mode===THREE.LinePieces?2:1;for(M=0,D=He.length/3-1;M<D;M+=we)N.pushLine(M,M+1)}}}else if(T instanceof THREE.Geometry){if(V.multiplyMatrices(z,p),0===(K=x.geometry.vertices).length)continue;(ue=W()).positionScreen.copy(K[0]).applyMatrix4(V);for(we=x.mode===THREE.LinePieces?2:1,$=1,_=K.length;$<_;$++)(ue=W()).positionScreen.copy(K[$]).applyMatrix4(V),($+1)%we>0||(he=h[i-2],C.copy(ue.positionScreen),k.copy(he.positionScreen),!0===O(C,k)&&(C.multiplyScalar(1/C.w),k.multiplyScalar(1/k.w),(a=F()).id=x.id,a.v1.positionScreen.copy(C),a.v2.positionScreen.copy(k),a.z=Math.max(C.z,k.z),a.material=x.material,x.material.vertexColors===THREE.VertexColors&&(a.vertexColors[0].copy(x.geometry.colors[$]),a.vertexColors[1].copy(x.geometry.colors[$-1])),y.elements.push(a)))}}else if(x instanceof THREE.Sprite){w.set(p.elements[12],p.elements[13],p.elements[14],1),w.applyMatrix4(z);var ge=1/w.w;w.z*=ge,w.z>=-1&&w.z<=1&&((c=P()).id=x.id,c.x=w.x*ge,c.y=w.y*ge,c.z=w.z,c.object=x,c.rotation=x.rotation,c.scale.x=x.scale.x*Math.abs(c.x-(w.x+f.projectionMatrix.elements[0])/(w.w+f.projectionMatrix.elements[12])),c.scale.y=x.scale.y*Math.abs(c.y-(w.y+f.projectionMatrix.elements[5])/(w.w+f.projectionMatrix.elements[13])),c.material=x.material,y.elements.push(c))}}return!0===m&&y.elements.sort(I),y}};
